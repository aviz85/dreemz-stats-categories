<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dream Analytics Dashboard - Complete</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .nav { background: rgba(255,255,255,0.95); padding: 15px 0; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .nav-container { max-width: 1200px; margin: 0 auto; display: flex; align-items: center; padding: 0 20px; }
        .nav h1 { color: #333; margin-right: 30px; }
        .nav-tabs { display: flex; gap: 20px; }
        .nav-tab {
            padding: 10px 20px; border: none; background: none; cursor: pointer;
            font-size: 16px; color: #666; border-radius: 5px; transition: all 0.2s;
        }
        .nav-tab.active { background: #667eea; color: white; }
        .nav-tab:hover { background: #f0f0f0; }
        .nav-tab.active:hover { background: #5a6fd8; }
        
        .container { max-width: 1200px; margin: 0 auto; padding: 30px 20px; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .stats { 
            display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 20px; margin-bottom: 30px; 
        }
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }
        .stat-number { font-size: 32px; font-weight: bold; color: #667eea; margin-bottom: 5px; }
        .stat-label { font-size: 14px; color: #666; }
        
        .section { 
            background: white; 
            border-radius: 15px; 
            padding: 30px; 
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }
        .section h2 { color: #333; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #667eea; }
        
        .controls { 
            margin-bottom: 25px; 
            display: flex; 
            gap: 15px; 
            flex-wrap: wrap; 
            align-items: center;
        }
        input, select, button {
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }
        input:focus, select:focus { outline: none; border-color: #667eea; }
        button {
            background: #667eea;
            color: white;
            border: none;
            cursor: pointer;
            transition: background 0.2s;
            font-weight: 500;
        }
        button:hover { background: #5a6fd8; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        
        .table-container { 
            background: white; 
            border-radius: 10px; 
            overflow: hidden; 
            border: 1px solid #e1e5e9;
            max-height: 600px;
            overflow-y: auto;
        }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 15px 12px; text-align: left; border-bottom: 1px solid #e1e5e9; }
        th { 
            background: #f8f9fa; 
            font-weight: 600; 
            position: sticky; 
            top: 0; 
            z-index: 10;
        }
        tr:hover { background: #f8f9fa; }
        
        .loading { text-align: center; padding: 50px; color: #666; }
        .error { 
            color: #dc3545; 
            padding: 20px; 
            background: #f8d7da; 
            border-radius: 8px; 
            margin: 15px 0; 
            border: 1px solid #f5c6cb;
        }
        .success {
            color: #155724;
            padding: 20px;
            background: #d4edda;
            border-radius: 8px;
            margin: 15px 0;
            border: 1px solid #c3e6cb;
        }
        
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
        }
        .pagination button {
            padding: 8px 12px;
            font-size: 12px;
        }
        .pagination span {
            color: #666;
            font-size: 14px;
        }
        
        .dream-details {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #667eea;
        }
        .dream-title { font-weight: bold; color: #333; margin-bottom: 10px; }
        .dream-stats { display: flex; gap: 20px; font-size: 14px; color: #666; }
        
        .clickable { cursor: pointer; }
        .clickable:hover { background: #e3f2fd !important; }
        
        .filter-summary {
            background: #e3f2fd;
            padding: 10px 15px;
            border-radius: 5px;
            margin-bottom: 15px;
            font-size: 14px;
            color: #1976d2;
        }
        
        @media (max-width: 768px) {
            .nav-container { flex-direction: column; gap: 15px; }
            .controls { flex-direction: column; align-items: stretch; }
            .stats { grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); }
        }
    </style>
</head>
<body>
    <nav class="nav">
        <div class="nav-container">
            <h1>üéØ Dream Analytics</h1>
            <div class="nav-tabs">
                <button class="nav-tab active" onclick="showTab('overview')">Overview</button>
                <button class="nav-tab" onclick="showTab('unique-dreams')">Unique Dreams</button>
                <button class="nav-tab" onclick="showTab('categories')">Categories</button>
                <button class="nav-tab" onclick="showTab('subcategories')">Subcategories</button>
                <button class="nav-tab" onclick="showTab('dream-details')">Dream Details</button>
            </div>
        </div>
    </nav>

    <div class="container">
        <!-- Overview Tab -->
        <div id="overview" class="tab-content active">
            <div class="stats" id="stats">
                <div class="stat-card">
                    <div class="stat-number" id="totalDreams">-</div>
                    <div class="stat-label">Total Dreams</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="uniqueTitles">-</div>
                    <div class="stat-label">Unique Titles</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="categories">-</div>
                    <div class="stat-label">Categories</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="subcategories">-</div>
                    <div class="stat-label">Subcategories</div>
                </div>
            </div>
            
            <div class="section">
                <h2>üìä Database Summary</h2>
                <div id="summaryContent">
                    <p>Loading database summary...</p>
                </div>
            </div>
        </div>

        <!-- Unique Dreams Tab -->
        <div id="unique-dreams" class="tab-content">
            <div class="section">
                <h2>üîç Unique Dreams Analysis</h2>
                <div class="controls">
                    <input type="text" id="searchInput" placeholder="Search dreams..." />
                    <input type="number" id="ageFrom" placeholder="Min age" min="3" max="125" />
                    <input type="number" id="ageTo" placeholder="Max age" min="3" max="125" />
                    <select id="sortBy">
                        <option value="count">Sort by Count</option>
                        <option value="title">Sort by Title</option>
                        <option value="avg_age">Sort by Avg Age</option>
                    </select>
                    <select id="limitSelect">
                        <option value="50">Show 50</option>
                        <option value="100">Show 100</option>
                        <option value="500">Show 500</option>
                        <option value="1000">Show 1000</option>
                        <option value="-1">Show All (Long Tail)</option>
                    </select>
                    <button onclick="searchDreams()">Search</button>
                    <button onclick="clearFilters()">Clear</button>
                </div>
                <div id="dreamFilters" class="filter-summary" style="display: none;"></div>
                <div class="table-container">
                    <table id="dreamsTable">
                        <thead>
                            <tr>
                                <th>Dream Title</th>
                                <th>Count</th>
                                <th>Avg Age</th>
                                <th>Age Range</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="dreamsBody">
                            <tr><td colspan="5" class="loading">Loading dreams...</td></tr>
                        </tbody>
                    </table>
                </div>
                <div class="pagination">
                    <button onclick="previousPage()" id="prevBtn" disabled>Previous</button>
                    <span id="pageInfo">Page 1</span>
                    <button onclick="nextPage()" id="nextBtn">Next</button>
                </div>
            </div>
        </div>

        <!-- Categories Tab -->
        <div id="categories" class="tab-content">
            <div class="section">
                <h2>üìä Categories Analysis</h2>
                <div class="controls">
                    <input type="number" id="catAgeFrom" placeholder="Min age" value="13" />
                    <input type="number" id="catAgeTo" placeholder="Max age" value="60" />
                    <button onclick="loadCategories()">Load Categories</button>
                </div>
                <div id="categoryFilters" class="filter-summary" style="display: none;"></div>
                <div class="table-container">
                    <table id="categoriesTable">
                        <thead>
                            <tr>
                                <th>Category</th>
                                <th>Dreams Count</th>
                                <th>Avg Age</th>
                                <th>Age Range</th>
                                <th>Age Group</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="categoriesBody">
                            <tr><td colspan="6" class="loading">Click "Load Categories" to view data...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Subcategories Tab -->
        <div id="subcategories" class="tab-content">
            <div class="section">
                <h2>üéØ Subcategories Analysis</h2>
                <div class="controls">
                    <input type="number" id="subAgeFrom" placeholder="Min age" value="18" />
                    <input type="number" id="subAgeTo" placeholder="Max age" value="25" />
                    <input type="text" id="subSearch" placeholder="Search subcategories..." />
                    <button onclick="loadSubcategories()">Load Subcategories</button>
                </div>
                <div id="subcategoryFilters" class="filter-summary" style="display: none;"></div>
                <div class="table-container">
                    <table id="subcategoriesTable">
                        <thead>
                            <tr>
                                <th>Subcategory</th>
                                <th>Dreams Count</th>
                                <th>Avg Age</th>
                                <th>Age Range</th>
                                <th>Age Group</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="subcategoriesBody">
                            <tr><td colspan="6" class="loading">Click "Load Subcategories" to view data...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Dream Details Tab -->
        <div id="dream-details" class="tab-content">
            <div class="section">
                <h2>üîç Dream Details Explorer</h2>
                <div class="controls">
                    <input type="text" id="detailSearch" placeholder="Enter dream title to explore..." />
                    <button onclick="loadDreamDetails()">Explore Dream</button>
                </div>
                <div id="dreamDetailsContent">
                    <p style="text-align: center; color: #666; padding: 40px;">
                        Enter a dream title above to see detailed information about that specific dream.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentOffset = 0;
        let currentLimit = 50;
        let currentFilters = {};
        let totalCount = 0;

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            loadStats();
            searchDreams();
        });

        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(btn => {
                btn.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');

            // Load data for specific tabs
            if (tabName === 'categories' && document.getElementById('categoriesBody').innerHTML.includes('Click "Load Categories"')) {
                loadCategories();
            } else if (tabName === 'subcategories' && document.getElementById('subcategoriesBody').innerHTML.includes('Click "Load Subcategories"')) {
                loadSubcategories();
            }
        }

        async function loadStats() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();
                
                if (data.database) {
                    const db = data.database;
                    document.getElementById('totalDreams').textContent = 
                        db.total_dreams?.toLocaleString() || '0';
                    document.getElementById('uniqueTitles').textContent = 
                        db.unique_titles?.toLocaleString() || '0';
                    document.getElementById('categories').textContent = 
                        db.categories || '0';
                    document.getElementById('subcategories').textContent = 
                        db.subcategories || '0';

                    // Update summary
                    const summaryHtml = `
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                            <div>
                                <h3 style="color: #667eea; margin-bottom: 10px;">üíæ Database Info</h3>
                                <p><strong>Total Dreams:</strong> ${db.total_dreams?.toLocaleString()}</p>
                                <p><strong>Unique Titles:</strong> ${db.unique_titles?.toLocaleString()}</p>
                                <p><strong>Duplicate Rate:</strong> ${((db.total_dreams - db.unique_titles) / db.total_dreams * 100).toFixed(1)}%</p>
                            </div>
                            <div>
                                <h3 style="color: #667eea; margin-bottom: 10px;">üìä Classification</h3>
                                <p><strong>Categories:</strong> ${db.categories}</p>
                                <p><strong>Subcategories:</strong> ${db.subcategories}</p>
                                <p><strong>Avg per Category:</strong> ${Math.round(db.subcategories / db.categories)} subcategories</p>
                            </div>
                        </div>
                    `;
                    document.getElementById('summaryContent').innerHTML = summaryHtml;
                }
            } catch (error) {
                console.error('Error loading stats:', error);
                showError('Failed to load database statistics');
            }
        }

        async function searchDreams() {
            currentOffset = 0;
            const search = document.getElementById('searchInput').value;
            const ageFrom = document.getElementById('ageFrom').value;
            const ageTo = document.getElementById('ageTo').value;
            const sortBy = document.getElementById('sortBy').value;
            const limitValue = document.getElementById('limitSelect').value;
            
            currentLimit = limitValue === '-1' ? 10000 : parseInt(limitValue);
            currentFilters = { search, ageFrom, ageTo, sortBy, limit: currentLimit };

            const params = new URLSearchParams({
                limit: currentLimit,
                offset: currentOffset,
                sort: sortBy,
                order: 'desc'
            });

            if (search) params.append('search', search);
            if (ageFrom) params.append('age_from', ageFrom);
            if (ageTo) params.append('age_to', ageTo);

            showFilters('dreamFilters', {
                search: search || 'All dreams',
                ageRange: (ageFrom || ageTo) ? `${ageFrom || 'any'}-${ageTo || 'any'} years` : 'All ages',
                sortBy: sortBy,
                limit: limitValue === '-1' ? 'All results (Long Tail)' : `Top ${limitValue}`
            });

            try {
                const response = await fetch(`/api/unique-dreams?${params}`);
                const data = await response.json();

                if (data.error) {
                    showError('API Error: ' + data.error);
                    return;
                }

                totalCount = data.total_count || 0;
                displayDreams(data.dreams || [], false);
                updatePagination();
            } catch (error) {
                console.error('Error searching dreams:', error);
                showError('Failed to load dreams data');
            }
        }

        async function loadCategories() {
            const ageFrom = document.getElementById('catAgeFrom').value || 3;
            const ageTo = document.getElementById('catAgeTo').value || 125;

            const params = new URLSearchParams({
                min_age: ageFrom,
                max_age: ageTo
            });

            showFilters('categoryFilters', {
                ageRange: `${ageFrom}-${ageTo} years`
            });

            try {
                const response = await fetch(`/api/categories-analysis?${params}`);
                const data = await response.json();

                if (data.error) {
                    showError('API Error: ' + data.error);
                    return;
                }

                displayCategories(data.categories || []);
            } catch (error) {
                console.error('Error loading categories:', error);
                showError('Failed to load categories data');
            }
        }

        async function loadSubcategories() {
            const ageFrom = document.getElementById('subAgeFrom').value || 3;
            const ageTo = document.getElementById('subAgeTo').value || 125;
            const search = document.getElementById('subSearch').value;

            const params = new URLSearchParams({
                min_age: ageFrom,
                max_age: ageTo
            });

            showFilters('subcategoryFilters', {
                ageRange: `${ageFrom}-${ageTo} years`,
                search: search || 'All subcategories'
            });

            try {
                const response = await fetch(`/api/subcategories-analysis?${params}`);
                const data = await response.json();

                if (data.error) {
                    showError('API Error: ' + data.error);
                    return;
                }

                let subcategories = data.categories || [];
                
                // Filter by search term if provided
                if (search) {
                    subcategories = subcategories.filter(sub => 
                        sub.category.toLowerCase().includes(search.toLowerCase())
                    );
                }

                displaySubcategories(subcategories);
            } catch (error) {
                console.error('Error loading subcategories:', error);
                showError('Failed to load subcategories data');
            }
        }

        async function loadDreamDetails() {
            const dreamTitle = document.getElementById('detailSearch').value.trim();
            if (!dreamTitle) {
                showError('Please enter a dream title to explore');
                return;
            }

            try {
                const response = await fetch(`/api/dream-details/${encodeURIComponent(dreamTitle)}`);
                const data = await response.json();

                if (data.error) {
                    showError('API Error: ' + data.error);
                    return;
                }

                displayDreamDetails(data);
            } catch (error) {
                console.error('Error loading dream details:', error);
                showError('Failed to load dream details');
            }
        }

        async function viewCategoryDreams(category, type = 'categories') {
            try {
                const params = new URLSearchParams({
                    category: category,
                    type: type
                });

                const response = await fetch(`/api/category-dreams?${params}`);
                const data = await response.json();

                if (data.error) {
                    showError('API Error: ' + data.error);
                    return;
                }

                // Switch to unique dreams tab and show filtered results
                showTab('unique-dreams');
                displayCategoryDreams(data.dreams || [], category, type);
            } catch (error) {
                console.error('Error loading category dreams:', error);
                showError('Failed to load category dreams');
            }
        }

        function displayDreams(dreams, append = false) {
            const tbody = document.getElementById('dreamsBody');
            
            if (!append) {
                tbody.innerHTML = '';
            }

            if (!dreams || dreams.length === 0) {
                if (!append) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #666;">No dreams found</td></tr>';
                }
                return;
            }

            dreams.forEach(dream => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="font-weight: 500;">${escapeHtml(dream.normalized_title || '')}</td>
                    <td><strong>${(dream.count || 0).toLocaleString()}</strong></td>
                    <td>${dream.avg_age ? dream.avg_age.toFixed(1) : '-'}</td>
                    <td>${dream.min_age || '-'} - ${dream.max_age || '-'}</td>
                    <td>
                        <button onclick="exploreSpecificDream('${escapeHtml(dream.normalized_title)}')" 
                                style="font-size: 12px; padding: 5px 10px;">Explore</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function displayCategories(categories) {
            const tbody = document.getElementById('categoriesBody');
            tbody.innerHTML = '';

            if (!categories || categories.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #666;">No categories found</td></tr>';
                return;
            }

            categories.forEach(cat => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="font-weight: 500;">${escapeHtml(cat.category || '')}</td>
                    <td><strong>${(cat.count || 0).toLocaleString()}</strong></td>
                    <td>${cat.avg_age ? cat.avg_age.toFixed(1) : '-'}</td>
                    <td>${cat.min_age || '-'} - ${cat.max_age || '-'}</td>
                    <td><span style="background: #e3f2fd; padding: 3px 8px; border-radius: 12px; font-size: 12px;">${cat.top_age_group || '-'}</span></td>
                    <td>
                        <button onclick="viewCategoryDreams('${escapeHtml(cat.category)}', 'categories')" 
                                style="font-size: 12px; padding: 5px 10px;">View Dreams</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function displaySubcategories(subcategories) {
            const tbody = document.getElementById('subcategoriesBody');
            tbody.innerHTML = '';

            if (!subcategories || subcategories.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #666;">No subcategories found</td></tr>';
                return;
            }

            subcategories.forEach(sub => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="font-weight: 500;">${escapeHtml(sub.category || '')}</td>
                    <td><strong>${(sub.count || 0).toLocaleString()}</strong></td>
                    <td>${sub.avg_age ? sub.avg_age.toFixed(1) : '-'}</td>
                    <td>${sub.min_age || '-'} - ${sub.max_age || '-'}</td>
                    <td><span style="background: #e8f5e9; padding: 3px 8px; border-radius: 12px; font-size: 12px;">${sub.top_age_group || '-'}</span></td>
                    <td>
                        <button onclick="viewCategoryDreams('${escapeHtml(sub.category)}', 'subcategories')" 
                                style="font-size: 12px; padding: 5px 10px;">View Dreams</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function displayCategoryDreams(dreams, category, type) {
            const tbody = document.getElementById('dreamsBody');
            tbody.innerHTML = '';

            // Update filter display
            showFilters('dreamFilters', {
                category: `${type}: ${category}`,
                note: `Showing dreams in this ${type.slice(0, -1)}`
            });

            if (!dreams || dreams.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #666;">No dreams found in this category</td></tr>';
                return;
            }

            dreams.forEach(dream => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="font-weight: 500;">${escapeHtml(dream.normalized_title || '')}</td>
                    <td><strong>${(dream.count || 0).toLocaleString()}</strong></td>
                    <td>-</td>
                    <td>${dream.min_age || '-'} - ${dream.max_age || '-'}</td>
                    <td>
                        <button onclick="exploreSpecificDream('${escapeHtml(dream.normalized_title)}')" 
                                style="font-size: 12px; padding: 5px 10px;">Explore</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function displayDreamDetails(data) {
            const container = document.getElementById('dreamDetailsContent');
            
            if (!data.dreams || data.dreams.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">No details found for this dream.</p>';
                return;
            }

            const dreams = data.dreams;
            const title = data.normalized_title;
            
            let html = `
                <div class="dream-details">
                    <div class="dream-title">${escapeHtml(title)}</div>
                    <div class="dream-stats">
                        <span><strong>Total instances:</strong> ${dreams.length}</span>
                        <span><strong>Age range:</strong> ${Math.min(...dreams.map(d => d.age))} - ${Math.max(...dreams.map(d => d.age))} years</span>
                    </div>
                </div>
            `;

            html += `
                <div class="table-container" style="margin-top: 20px;">
                    <table>
                        <thead>
                            <tr>
                                <th>User</th>
                                <th>Age</th>
                                <th>Categories</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            dreams.forEach(dream => {
                const categories = dream.categories ? dream.categories
                    .filter(cat => cat && cat.category)
                    .map(cat => `${cat.category}${cat.subcategory ? ' ‚Üí ' + cat.subcategory : ''}`)
                    .join('<br>') : 'No categories';

                html += `
                    <tr>
                        <td>${escapeHtml(dream.username || 'Anonymous')}</td>
                        <td>${dream.age || '-'}</td>
                        <td style="font-size: 12px;">${categories}</td>
                    </tr>
                `;
            });

            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        function exploreSpecificDream(title) {
            showTab('dream-details');
            document.getElementById('detailSearch').value = title;
            loadDreamDetails();
        }

        function showFilters(containerId, filters) {
            const container = document.getElementById(containerId);
            if (!container) return;

            const filterText = Object.entries(filters)
                .map(([key, value]) => `<strong>${key}:</strong> ${value}`)
                .join(' | ');

            container.innerHTML = filterText;
            container.style.display = 'block';
        }

        function nextPage() {
            if (currentOffset + currentLimit < totalCount) {
                currentOffset += currentLimit;
                searchDreamsPage();
            }
        }

        function previousPage() {
            if (currentOffset > 0) {
                currentOffset = Math.max(0, currentOffset - currentLimit);
                searchDreamsPage();
            }
        }

        function updatePagination() {
            const currentPage = Math.floor(currentOffset / currentLimit) + 1;
            const totalPages = Math.ceil(totalCount / currentLimit);
            
            document.getElementById('pageInfo').textContent = 
                `Page ${currentPage} of ${totalPages} (${totalCount.toLocaleString()} total)`;
            
            document.getElementById('prevBtn').disabled = currentOffset === 0;
            document.getElementById('nextBtn').disabled = currentOffset + currentLimit >= totalCount;
        }

        async function searchDreamsPage() {
            const params = new URLSearchParams({
                limit: currentLimit,
                offset: currentOffset,
                sort: currentFilters.sortBy || 'count',
                order: 'desc'
            });

            if (currentFilters.search) params.append('search', currentFilters.search);
            if (currentFilters.ageFrom) params.append('age_from', currentFilters.ageFrom);
            if (currentFilters.ageTo) params.append('age_to', currentFilters.ageTo);

            try {
                const response = await fetch(`/api/unique-dreams?${params}`);
                const data = await response.json();

                if (data.error) {
                    showError('API Error: ' + data.error);
                    return;
                }

                displayDreams(data.dreams || [], false);
                updatePagination();
            } catch (error) {
                console.error('Error loading page:', error);
                showError('Failed to load dreams data');
            }
        }

        function clearFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('ageFrom').value = '';
            document.getElementById('ageTo').value = '';
            document.getElementById('sortBy').value = 'count';
            document.getElementById('limitSelect').value = '50';
            document.getElementById('dreamFilters').style.display = 'none';
            searchDreams();
        }

        function showError(message) {
            const container = document.querySelector('.container');
            const existing = container.querySelector('.error');
            if (existing) existing.remove();
            
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = message;
            container.insertBefore(errorDiv, container.firstChild);
            
            setTimeout(() => errorDiv.remove(), 8000);
        }

        function showSuccess(message) {
            const container = document.querySelector('.container');
            const existing = container.querySelector('.success');
            if (existing) existing.remove();
            
            const successDiv = document.createElement('div');
            successDiv.className = 'success';
            successDiv.textContent = message;
            container.insertBefore(successDiv, container.firstChild);
            
            setTimeout(() => successDiv.remove(), 5000);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>